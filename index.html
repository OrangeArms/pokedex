// å…¨å±€å˜é‡
let currentPage = 1;
const pokemonsPerPage = 20;
let allPokemons = [];
let filteredPokemons = [];
let currentGeneration = 'all';

// ä¸–ä»£èŒƒå›´å®šä¹‰
const generations = {
    '1': { start: 1, end: 151, name: 'å…³éƒ½åœ°åŒº' },
    '2': { start: 152, end: 251, name: 'åŸéƒ½åœ°åŒº' },
    '3': { start: 252, end: 386, name: 'ä¸°ç¼˜åœ°åŒº' },
    '4': { start: 387, end: 493, name: 'ç¥å¥¥åœ°åŒº' },
    '5': { start: 494, end: 649, name: 'åˆä¼—åœ°åŒº' },
    '6': { start: 650, end: 721, name: 'å¡æ´›æ–¯åœ°åŒº' },
    '7': { start: 722, end: 809, name: 'é˜¿ç½—æ‹‰åœ°åŒº' },
    '8': { start: 810, end: 905, name: 'ä¼½å‹’å°”åœ°åŒº' },
    '9': { start: 906, end: 1025, name: 'å¸•åº•äºšåœ°åŒº' }
};

// ä¸­æ–‡åç§°æ˜ å°„ (è¿™é‡ŒåªåŒ…å«éƒ¨åˆ†ï¼Œå®Œæ•´ç‰ˆå¤ªé•¿äº†)
const chineseNames = {
    // ç¬¬ä¸€ä¸–ä»£ (å…³éƒ½åœ°åŒº)
    'bulbasaur': 'å¦™è›™ç§å­', 'ivysaur': 'å¦™è›™è‰', 'venusaur': 'å¦™è›™èŠ±',
    'charmander': 'å°ç«é¾™', 'charmeleon': 'ç«æé¾™', 'charizard': 'å–·ç«é¾™',
    'squirtle': 'æ°å°¼é¾Ÿ', 'wartortle': 'å¡å’ªé¾Ÿ', 'blastoise': 'æ°´ç®­é¾Ÿ',
    'caterpie': 'ç»¿æ¯›è™«', 'metapod': 'é“ç”²è›¹', 'butterfree': 'å·´å¤§è¶',
    'weedle': 'ç‹¬è§’è™«', 'kakuna': 'é“å£³è›¹', 'beedrill': 'å¤§é’ˆèœ‚',
    'pidgey': 'æ³¢æ³¢', 'pidgeotto': 'æ¯”æ¯”é¸Ÿ', 'pidgeot': 'å¤§æ¯”é¸Ÿ',
    'rattata': 'å°æ‹‰è¾¾', 'raticate': 'æ‹‰è¾¾', 'spearow': 'çƒˆé›€',
    'fearow': 'å¤§å˜´é›€', 'ekans': 'é˜¿æŸè›‡', 'arbok': 'é˜¿æŸæ€ª',
    'pikachu': 'çš®å¡ä¸˜', 'raichu': 'é›·ä¸˜', 'sandshrew': 'ç©¿å±±é¼ ',
    'sandslash': 'ç©¿å±±ç‹', 'nidoran-f': 'å°¼å¤šå…°', 'nidorina': 'å°¼å¤šå¨œ',
    'nidoqueen': 'å°¼å¤šå', 'nidoran-m': 'å°¼å¤šæœ—', 'nidorino': 'å°¼å¤šåŠ›è¯º',
    'nidoking': 'å°¼å¤šç‹', 'clefairy': 'çš®çš®', 'clefable': 'çš®å¯è¥¿',
    'vulpix': 'å…­å°¾', 'ninetales': 'ä¹å°¾', 'jigglypuff': 'èƒ–ä¸',
    'wigglytuff': 'èƒ–å¯ä¸', 'zubat': 'è¶…éŸ³è ', 'golbat': 'å¤§å˜´è ',
    'oddish': 'èµ°è·¯è‰', 'gloom': 'è‡­è‡­èŠ±', 'vileplume': 'éœ¸ç‹èŠ±',
    'paras': 'æ´¾æ‹‰æ–¯', 'parasect': 'æ´¾æ‹‰æ–¯ç‰¹', 'venonat': 'æ¯›çƒ',
    'venomoth': 'æ‘©é²è›¾', 'diglett': 'åœ°é¼ ', 'dugtrio': 'ä¸‰åœ°é¼ ',
    'meowth': 'å–µå–µ', 'persian': 'çŒ«è€å¤§', 'psyduck': 'å¯è¾¾é¸­',
    'golduck': 'å“¥è¾¾é¸­', 'mankey': 'çŒ´æ€ª', 'primeape': 'ç«æš´çŒ´',
    'growlithe': 'å¡è’‚ç‹—', 'arcanine': 'é£é€Ÿç‹—', 'poliwag': 'èšŠé¦™èŒèšª',
    'poliwhirl': 'èšŠé¦™å›', 'poliwrath': 'èšŠé¦™æ³³å£«', 'abra': 'å‡¯è¥¿',
    'kadabra': 'å‹‡åŸºæ‹‰', 'alakazam': 'èƒ¡åœ°', 'machop': 'è…•åŠ›',
    'machoke': 'è±ªåŠ›', 'machamp': 'æ€ªåŠ›', 'bellsprout': 'å–‡å­èŠ½',
    'weepinbell': 'å£å‘†èŠ±', 'victreebel': 'å¤§é£ŸèŠ±', 'tentacool': 'ç›ç‘™æ°´æ¯',
    'tentacruel': 'æ¯’åˆºæ°´æ¯', 'geodude': 'å°æ‹³çŸ³', 'graveler': 'éš†éš†çŸ³',
    'golem': 'éš†éš†å²©', 'ponyta': 'å°ç«é©¬', 'rapidash': 'çƒˆç„°é©¬',
    'slowpoke': 'å‘†å‘†å…½', 'slowbro': 'å‘†æ²³é©¬', 'magnemite': 'å°ç£æ€ª',
    'magneton': 'ä¸‰åˆä¸€ç£æ€ª', 'farfetchd': 'å¤§è‘±é¸­', 'doduo': 'å˜Ÿå˜Ÿ',
    'dodrio': 'å˜Ÿå˜Ÿåˆ©', 'seel': 'å°æµ·ç‹®', 'dewgong': 'ç™½æµ·ç‹®',
    'grimer': 'è‡­æ³¥', 'muk': 'è‡­è‡­æ³¥', 'shellder': 'å¤§èˆŒè´',
    'cloyster': 'åˆºç”²è´', 'gastly': 'é¬¼æ–¯', 'haunter': 'é¬¼æ–¯é€š',
    'gengar': 'è€¿é¬¼', 'onix': 'å¤§å²©è›‡', 'drowzee': 'å‚¬çœ è²˜',
    'hypno': 'å¼•æ¢¦è²˜äºº', 'krabby': 'å¤§é’³èŸ¹', 'kingler': 'å·¨é’³èŸ¹',
    'voltorb': 'éœ¹é›³ç”µçƒ', 'electrode': 'é¡½çš®é›·å¼¹', 'exeggcute': 'è›‹è›‹',
    'exeggutor': 'æ¤°è›‹æ ‘', 'cubone': 'å¡æ‹‰å¡æ‹‰', 'marowak': 'å˜å•¦å˜å•¦',
    'hitmonlee': 'é£è…¿éƒ', 'hitmonchan': 'å¿«æ‹³éƒ', 'lickitung': 'å¤§èˆŒå¤´',
    'koffing': 'ç“¦æ–¯å¼¹', 'weezing': 'åŒå¼¹ç“¦æ–¯', 'rhyhorn': 'ç‹¬è§’çŠ€ç‰›',
    'rhydon': 'é’»è§’çŠ€å…½', 'chansey': 'å‰åˆ©è›‹', 'tangela': 'è”“è—¤æ€ª',
    'kangaskhan': 'è¢‹å…½', 'horsea': 'å¢¨æµ·é©¬', 'seadra': 'æµ·åˆºé¾™',
    'goldeen': 'è§’é‡‘é±¼', 'seaking': 'é‡‘é±¼ç‹', 'staryu': 'æµ·æ˜Ÿæ˜Ÿ',
    'starmie': 'å®çŸ³æµ·æ˜Ÿ', 'mr-mime': 'é­”å¢™äººå¶', 'scyther': 'é£å¤©è³è‚',
    'jynx': 'è¿·å”‡å§', 'electabuzz': 'ç”µå‡»å…½', 'magmar': 'é¸­å˜´ç«å…½',
    'pinsir': 'å‡¯ç½—æ–¯', 'tauros': 'è‚¯æ³°ç½—', 'magikarp': 'é²¤é±¼ç‹',
    'gyarados': 'æš´é²¤é¾™', 'lapras': 'æ‹‰æ™®æ‹‰æ–¯', 'ditto': 'ç™¾å˜æ€ª',
    'eevee': 'ä¼Šå¸ƒ', 'vaporeon': 'æ°´ä¼Šå¸ƒ', 'jolteon': 'é›·ä¼Šå¸ƒ',
    'flareon': 'ç«ä¼Šå¸ƒ', 'porygon': 'å¤šè¾¹å…½', 'omanyte': 'èŠçŸ³å…½',
    'omastar': 'å¤šåˆºèŠçŸ³å…½', 'kabuto': 'åŒ–çŸ³ç›”', 'kabutops': 'é•°åˆ€ç›”',
    'aerodactyl': 'åŒ–çŸ³ç¿¼é¾™', 'snorlax': 'å¡æ¯”å…½', 'articuno': 'æ€¥å†»é¸Ÿ',
    'zapdos': 'é—ªç”µé¸Ÿ', 'moltres': 'ç«ç„°é¸Ÿ', 'dratini': 'è¿·ä½ é¾™',
    'dragonair': 'å“ˆå…‹é¾™', 'dragonite': 'å¿«é¾™', 'mewtwo': 'è¶…æ¢¦',
    'mew': 'æ¢¦å¹»',
    
    // ç¬¬äºŒä¸–ä»£ (åŸéƒ½åœ°åŒº) éƒ¨åˆ†ä»£è¡¨
    'chikorita': 'èŠè‰å¶', 'bayleef': 'æœˆæ¡‚å¶', 'meganium': 'å¤§ç«ºè‘µ',
    'cyndaquil': 'ç«çƒé¼ ', 'quilava': 'ç«å²©é¼ ', 'typhlosion': 'ç«æš´å…½',
    'totodile': 'å°é”¯é³„', 'croconaw': 'è“é³„', 'feraligatr': 'å¤§åŠ›é³„',
    'togepi': 'æ³¢å…‹æ¯”', 'togetic': 'æ³¢å…‹åŸºå¤', 'togekiss': 'æ³¢å…‹åŸºæ–¯',
    'ampharos': 'ç”µé¾™', 'marill': 'ç›åŠ›éœ²', 'azumarill': 'ç›åŠ›éœ²ä¸½',
    'sudowoodo': 'æ ‘æ‰æ€ª', 'politoed': 'èšŠé¦™è›™çš‡', 'espeon': 'å¤ªé˜³ä¼Šå¸ƒ',
    'umbreon': 'æœˆäº®ä¼Šå¸ƒ', 'slowking': 'å‘†å‘†ç‹', 'unown': 'æœªçŸ¥å›¾è…¾',
    'wobbuffet': 'æœç„¶ç¿', 'girafarig': 'éº’éºŸå¥‡', 'pineco': 'æ¦›æœçƒ',
    'forretress': 'ä½›çƒˆæ‰˜æ–¯', 'dunsparce': 'åœŸé¾™å¼Ÿå¼Ÿ', 'gligar': 'å¤©è',
    'steelix': 'å¤§é’¢è›‡', 'scizor': 'å·¨é’³è³è‚', 'heracross': 'èµ«æ‹‰å…‹ç½—æ–¯',
    'sneasel': 'ç‹ƒæ‹‰', 'teddiursa': 'ç†Šå®å®', 'ursaring': 'åœˆåœˆç†Š',
    'piloswine': 'é•¿æ¯›çŒª', 'corsola': 'å¤ªé˜³çŠç‘š', 'octillery': 'ç« é±¼æ¡¶',
    'delibird': 'ä¿¡ä½¿é¸Ÿ', 'mantine': 'å·¨ç¿…é£é±¼', 'skarmory': 'ç›”ç”²é¸Ÿ',
    'houndour': 'æˆ´é²æ¯”', 'houndoom': 'é»‘é²åŠ ', 'kingdra': 'åˆºé¾™ç‹',
    'phanpy': 'å°å°è±¡', 'donphan': 'é¡¿ç”²', 'porygon2': 'å¤šè¾¹å…½â…¡',
    'stantler': 'æƒŠè§’é¹¿', 'smeargle': 'å›¾å›¾çŠ¬', 'tyrogue': 'å·´å°”éƒ',
    'hitmontop': 'æŸ¯æ³¢æœ—', 'smoochum': 'è¿·å”‡å¨ƒ', 'elekid': 'ç”µå‡»æ€ª',
    'magby': 'é¸­å˜´å®å®', 'miltank': 'å¤§å¥¶ç½', 'blissey': 'å¹¸ç¦è›‹',
    'raikou': 'é›·å…¬', 'entei': 'ç‚å¸', 'suicune': 'æ°´å›',
    'larvitar': 'å¹¼åŸºæ‹‰æ–¯', 'pupitar': 'æ²™åŸºæ‹‰æ–¯', 'tyranitar': 'ç­åŸºæ‹‰æ–¯',
    'lugia': 'æ´›å¥‡äºš', 'ho-oh': 'å‡¤ç‹', 'celebi': 'æ—¶æ‹‰æ¯”',
    
    // ç¬¬å…«ä¸–ä»£ (ä¼½å‹’å°”åœ°åŒº) éƒ¨åˆ†ä»£è¡¨
    'grookey': 'æ•²éŸ³çŒ´', 'thwackey': 'å•ªå’šçŒ´', 'rillaboom': 'è½°æ“‚é‡‘åˆšçŒ©',
    'scorbunny': 'ç‚å…”å„¿', 'raboot': 'è…¾è¹´å°å°†', 'cinderace': 'é—ªç„°ç‹ç‰Œ',
    'sobble': 'æ³ªçœ¼èœ¥', 'drizzile': 'å˜æ¶©èœ¥', 'inteleon': 'åƒé¢é¿å½¹',
    'wooloo': 'æ¯›è¾«ç¾Š', 'dubwool': 'æ¯›æ¯›è§’ç¾Š', 'yamper': 'æ¥ç”µæ±ª',
    'boltund': 'é€ç”µçŠ¬', 'corviknight': 'é“ é¸¦', 'toxtricity': 'é¢¤å¼¦è¾èˆ',
    'eternatus': 'æ— ææ±°é‚£', 'zacian': 'è‹å“', 'zamazenta': 'è—ç›ç„¶ç‰¹',
    
    // ç¬¬ä¹ä¸–ä»£ (å¸•åº•äºšåœ°åŒº) éƒ¨åˆ†ä»£è¡¨
    'sprigatito': 'æ–°å¶å–µ', 'floragato': 'è’‚è•¾å–µ', 'meowscarada': 'é­”å¹»å‡é¢å–µ',
    'fuecoco': 'å‘†ç«é³„', 'crocalor': 'ç‚™çƒ«é³„', 'skeledirge': 'éª¨çº¹å·¨å£°é³„',
    'quaxly': 'æ¶¦æ°´é¸­', 'quaxwell': 'æ¶Œè·ƒé¸­', 'quaquaval': 'ç‹‚æ¬¢æµªèˆé¸­',
    'lechonk': 'çˆ±åƒè±š', 'oinkologne': 'é£˜é¦™è±š', 'pawmi': 'ç”µæ°”é¼ ',
    'pawmo': 'ç”µæ°”çŒ«', 'pawmot': 'ç”µæ°”é­”å…½', 'koraidon': 'æ•…å‹’é¡¿',
    'miraidon': 'å¯†å‹’é¡¿', 'gimmighoul': 'å°æœ¨çµ', 'gholdengo': 'é‡‘ä¸çŒ´'
};

// DOM å…ƒç´ 
let pokemonContainer;
let searchInput;
let searchButton;
let prevButton;
let nextButton;
let firstPageButton;
let lastPageButton;
let currentPageSpan;
let totalPagesSpan;
let pageInput;
let jumpButton;
let modal;
let modalClose;
let pokemonDetails;

// è·å–å®å¯æ¢¦æ•°æ®
async function fetchPokemons() {
    try {
        pokemonContainer.innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½å®å¯æ¢¦æ•°æ®ï¼Œè¯·ç¨å€™...</p>';
        
        // åˆå§‹åªåŠ è½½ç¬¬ä¸€ä¸–ä»£å®å¯æ¢¦ï¼Œæé«˜é¦–æ¬¡åŠ è½½é€Ÿåº¦
        const gen1 = await fetchPokemonsByRange(1, 151);
        
        // æŒ‰IDæ’åº
        allPokemons = [...gen1].filter(p => p !== null);
        allPokemons.sort((a, b) => a.id - b.id);
        
        filteredPokemons = [...allPokemons];
        displayPokemons();
        
        console.log(`æˆåŠŸåŠ è½½äº†ç¬¬ä¸€ä¸–ä»£ ${allPokemons.length} ä¸ªå®å¯æ¢¦`);
        
        // åœ¨åå°ç»§ç»­åŠ è½½å…¶ä»–ä¸–ä»£
        loadRemainingGenerations();
    } catch (error) {
        console.error('è·å–å®å¯æ¢¦æ•°æ®å¤±è´¥:', error);
        pokemonContainer.innerHTML = '<p class="error">è·å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</p>';
    }
}

// åœ¨åå°åŠ è½½å…¶ä½™ä¸–ä»£çš„å®å¯æ¢¦
async function loadRemainingGenerations() {
    try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'loading-indicator';
        loadingIndicator.textContent = 'æ­£åœ¨åå°åŠ è½½æ›´å¤šå®å¯æ¢¦...';
        document.body.appendChild(loadingIndicator);
        
        // ç¬¬äºŒä¸–ä»£ (152-251)
        const gen2 = await fetchPokemonsByRange(152, 251);
        allPokemons = [...allPokemons, ...gen2.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬ä¸‰ä¸–ä»£ (252-386)
        const gen3 = await fetchPokemonsByRange(252, 386);
        allPokemons = [...allPokemons, ...gen3.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬å››ä¸–ä»£ (387-493)
        const gen4 = await fetchPokemonsByRange(387, 493);
        allPokemons = [...allPokemons, ...gen4.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬äº”ä¸–ä»£ (494-649)
        const gen5 = await fetchPokemonsByRange(494, 649);
        allPokemons = [...allPokemons, ...gen5.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬å…­ä¸–ä»£ (650-721)
        const gen6 = await fetchPokemonsByRange(650, 721);
        allPokemons = [...allPokemons, ...gen6.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬ä¸ƒä¸–ä»£ (722-809)
        const gen7 = await fetchPokemonsByRange(722, 809);
        allPokemons = [...allPokemons, ...gen7.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬å…«ä¸–ä»£ (810-905)
        const gen8 = await fetchPokemonsByRange(810, 905);
        allPokemons = [...allPokemons, ...gen8.filter(p => p !== null)];
        updatePokemonData();
        
        // ç¬¬ä¹ä¸–ä»£ (906-1025)
        const gen9 = await fetchPokemonsByRange(906, 1025);
        allPokemons = [...allPokemons, ...gen9.filter(p => p !== null)];
        
        // æœ€ç»ˆæ›´æ–°
        updatePokemonData();
        
        // ç§»é™¤åŠ è½½æç¤º
        document.body.removeChild(loadingIndicator);
        
        console.log(`æˆåŠŸåŠ è½½äº†æ‰€æœ‰ ${allPokemons.length} ä¸ªå®å¯æ¢¦`);
    } catch (error) {
        console.error('åå°åŠ è½½å®å¯æ¢¦æ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°å®å¯æ¢¦æ•°æ®
function updatePokemonData() {
    // æŒ‰IDæ’åº
    allPokemons.sort((a, b) => a.id - b.id);
    
    // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯"å…¨éƒ¨"ï¼Œåˆ™æ›´æ–°è¿‡æ»¤åçš„å®å¯æ¢¦
    if (currentGeneration === 'all') {
        filteredPokemons = [...allPokemons];
        displayPokemons();
    }
}

// æŒ‰IDèŒƒå›´è·å–å®å¯æ¢¦
async function fetchPokemonsByRange(startId, endId) {
    pokemonContainer.innerHTML = `<p class="loading">æ­£åœ¨åŠ è½½ç¬¬${getGeneration(startId).number}ä¸–ä»£å®å¯æ¢¦æ•°æ®ï¼Œè¯·ç¨å€™...</p>`;
    
    const pokemonPromises = [];
    for (let id = startId; id <= endId; id++) {
        pokemonPromises.push(fetchPokemonById(id));
    }
    
    return await Promise.all(pokemonPromises);
}

// é€šè¿‡IDè·å–å•ä¸ªå®å¯æ¢¦
async function fetchPokemonById(id) {
    try {
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        return await response.json();
    } catch (error) {
        console.error(`è·å–å®å¯æ¢¦ ID:${id} æ•°æ®å¤±è´¥:`, error);
        return null;
    }
}

// æ˜¾ç¤ºå®å¯æ¢¦
function displayPokemons() {
    pokemonContainer.innerHTML = '';
    
    const totalPages = Math.ceil(filteredPokemons.length / pokemonsPerPage);
    currentPageSpan.textContent = currentPage;
    totalPagesSpan.textContent = totalPages;
    
    const start = (currentPage - 1) * pokemonsPerPage;
    const end = start + pokemonsPerPage;
    const pokemonsToDisplay = filteredPokemons.slice(start, end);
    
    if (pokemonsToDisplay.length === 0) {
        pokemonContainer.innerHTML = '<p class="no-results">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å®å¯æ¢¦</p>';
        return;
    }
    
    // æ·»åŠ å¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µæ¥æé«˜æ€§èƒ½
    const fragment = document.createDocumentFragment();
    
    pokemonsToDisplay.forEach(pokemon => {
        const pokemonCard = document.createElement('div');
        pokemonCard.classList.add('pokemon-card');
        pokemonCard.addEventListener('click', () => showPokemonDetails(pokemon));
        
        const types = pokemon.types.map(type => {
            return `<span class="type type-${type.type.name}">${getChineseType(type.type.name)}</span>`;
        }).join('');
        
        // è·å–ä¸­æ–‡åç§°
        const chineseName = chineseNames[pokemon.name] || capitalizeFirstLetter(pokemon.name);
        
        // è·å–ä¸–ä»£ä¿¡æ¯
        const generation = getGeneration(pokemon.id);
        
        pokemonCard.innerHTML = `
            <img src="${pokemon.sprites.other['official-artwork']?.front_default || pokemon.sprites.front_default}" alt="${pokemon.name}" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.id}.png'">
            <h3>#${pokemon.id.toString().padStart(4, '0')} ${chineseName}</h3>
            <div>${types}</div>
            <p class="generation">ç¬¬${generation.number}ä¸–ä»£ (${generation.name})</p>
        `;
        
        fragment.appendChild(pokemonCard);
    });
    
    pokemonContainer.appendChild(fragment);
    
    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    firstPageButton.disabled = currentPage === 1;
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages;
    lastPageButton.disabled = currentPage === totalPages;
}

// æŒ‰ä¸–ä»£è¿‡æ»¤å®å¯æ¢¦
function filterByGeneration(genNumber) {
    console.log(`è¿‡æ»¤ä¸–ä»£: ${genNumber}, å½“å‰å®å¯æ¢¦æ€»æ•°: ${allPokemons.length}`);
    
    if (genNumber === 'all') {
        filteredPokemons = [...allPokemons];
    } else {
        const gen = generations[genNumber];
        if (!gen) {
            console.error(`æœªæ‰¾åˆ°ä¸–ä»£ä¿¡æ¯: ${genNumber}`);
            return;
        }
        
        filteredPokemons = allPokemons.filter(pokemon => 
            pokemon.id >= gen.start && pokemon.id <= gen.end
        );
    }
    
    console.log(`è¿‡æ»¤åå®å¯æ¢¦æ•°é‡: ${filteredPokemons.length}`);
    
    // é‡ç½®é¡µç å¹¶æ˜¾ç¤º
    currentPage = 1;
    displayPokemons();
}

// æœç´¢å®å¯æ¢¦
function searchPokemons() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (searchTerm === '') {
        // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œåˆ™æŒ‰å½“å‰é€‰æ‹©çš„ä¸–ä»£è¿‡æ»¤
        filterByGeneration(currentGeneration);
    } else {
        // å…ˆæŒ‰ä¸–ä»£è¿‡æ»¤
        let genFiltered = [];
        if (currentGeneration === 'all') {
            genFiltered = [...allPokemons];
        } else {
            const gen = generations[currentGeneration];
            genFiltered = allPokemons.filter(pokemon => 
                pokemon.id >= gen.start && pokemon.id <= gen.end
            );
        }
        
        // å†æŒ‰æœç´¢è¯è¿‡æ»¤
        filteredPokemons = genFiltered.filter(pokemon => {
            // è‹±æ–‡åç§°æœç´¢
            const nameMatch = pokemon.name.toLowerCase().includes(searchTerm);
            // IDæœç´¢
            const idMatch = pokemon.id.toString() === searchTerm;
            // å±æ€§æœç´¢
            const typeMatch = pokemon.types.some(type => 
                type.type.name.toLowerCase().includes(searchTerm) || 
                getChineseType(type.type.name).includes(searchTerm)
            );
            // ä¸­æ–‡åç§°æœç´¢
            const chineseName = chineseNames[pokemon.name] || '';
            const chineseNameMatch = chineseName.includes(searchTerm);
            
            return nameMatch || idMatch || typeMatch || chineseNameMatch;
        });
    }
    
    currentPage = 1;
    displayPokemons();
}

// æ˜¾ç¤ºå®å¯æ¢¦è¯¦æƒ…
function showPokemonDetails(pokemon) {
    const types = pokemon.types.map(type => {
        return `<span class="type type-${type.type.name}">${getChineseType(type.type.name)}</span>`;
    }).join('');
    
    const stats = pokemon.stats.map(stat => {
        const statPercent = (stat.base_stat / 255) * 100;
        return `
            <div class="stat-bar">
                <div class="stat-fill" style="width: ${statPercent}%">
                    <span class="stat-name">${getChineseStat(stat.stat.name)}</span>
                    <span class="stat-value">${stat.base_stat}</span>
                </div>
            </div>
        `;
    }).join('');
    
    const abilities = pokemon.abilities.map(ability => {
        return capitalizeFirstLetter(ability.ability.name);
    }).join(', ');
    
    // è·å–ä¸­æ–‡åç§°
    const chineseName = chineseNames[pokemon.name] || capitalizeFirstLetter(pokemon.name);
    
    // è·å–ä¸–ä»£ä¿¡æ¯
    const generation = getGeneration(pokemon.id);
    
    // è·å–å®å¯æ¢¦çš„è¿›åŒ–é“¾ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    fetchEvolutionChain(pokemon.id).then(evolutionHTML => {
        pokemonDetails.innerHTML = `
            <h2>#${pokemon.id.toString().padStart(4, '0')} ${chineseName} (${capitalizeFirstLetter(pokemon.name)})</h2>
            <p class="generation-detail">ç¬¬${generation.number}ä¸–ä»£ (${generation.name})</p>
            <div class="pokemon-images">
                <img src="${pokemon.sprites.other['official-artwork']?.front_default || pokemon.sprites.front_default}" alt="${pokemon.name}" class="main-image" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.id}.png'">
                <div class="sprite-gallery">
                    ${pokemon.sprites.front_default ? `<img src="${pokemon.sprites.front_default}" alt="æ­£é¢" title="æ­£é¢">` : ''}
                    ${pokemon.sprites.back_default ? `<img src="${pokemon.sprites.back_default}" alt="èƒŒé¢" title="èƒŒé¢">` : ''}
                    ${pokemon.sprites.front_shiny ? `<img src="${pokemon.sprites.front_shiny}" alt="é—ªå…‰æ­£é¢" title="é—ªå…‰æ­£é¢">` : ''}
                    ${pokemon.sprites.back_shiny ? `<img src="${pokemon.sprites.back_shiny}" alt="é—ªå…‰èƒŒé¢" title="é—ªå…‰èƒŒé¢">` : ''}
                </div>
            </div>
            <div class="pokemon-info">
                <div class="info-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div>${types}</div>
                    <p>èº«é«˜: ${pokemon.height / 10}m</p>
                    <p>ä½“é‡: ${pokemon.weight / 10}kg</p>
                    <p>ç‰¹æ€§: ${abilities}</p>
                </div>
                
                <div class="info-section">
                    <h3>èƒ½åŠ›å€¼</h3>
                    ${stats}
                </div>
                
                <div class="info-section evolution-chain">
                    <h3>è¿›åŒ–é“¾</h3>
                    <div class="evolution-container">
                        ${evolutionHTML}
                    </div>
                </div>
                
                <div class="info-section">
                    <h3>æ”¶è—</h3>
                    <button id="favorite-button" class="favorite-button" onclick="toggleFavorite(${pokemon.id})">
                        ${isFavorite(pokemon.id) ? 'â¤ï¸ å–æ¶ˆæ”¶è—' : 'ğŸ¤ æ·»åŠ æ”¶è—'}
                    </button>
                </div>
            </div>
        `;
        
        // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
        updateFavoriteButton(pokemon.id);
    });
    
    modal.style.display = 'block';
}

// è·å–å®å¯æ¢¦è¿›åŒ–é“¾
async function fetchEvolutionChain(pokemonId) {
    try {
        // å…ˆè·å–å®å¯æ¢¦ç§ç±»ä¿¡æ¯
        const speciesResponse = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${pokemonId}/`);
        const speciesData = await speciesResponse.json();
        
        // è·å–è¿›åŒ–é“¾URL
        const evolutionChainUrl = speciesData.evolution_chain.url;
        
        // è·å–è¿›åŒ–é“¾æ•°æ®
        const evolutionResponse = await fetch(evolutionChainUrl);
        const evolutionData = await evolutionResponse.json();
        
        // å¤„ç†è¿›åŒ–é“¾æ•°æ®
        return renderEvolutionChain(evolutionData.chain);
    } catch (error) {
        console.error('è·å–è¿›åŒ–é“¾å¤±è´¥:', error);
        return '<p>æ— æ³•åŠ è½½è¿›åŒ–ä¿¡æ¯</p>';
    }
}

// æ¸²æŸ“è¿›åŒ–é“¾
function renderEvolutionChain(chain) {
    if (!chain) return '<p>æ— è¿›åŒ–ä¿¡æ¯</p>';
    
    let html = '<div class="evolution-stage">';
    
    // è·å–å½“å‰å®å¯æ¢¦
    const currentPokemon = chain.species;
    const currentPokemonId = extractPokemonId(currentPokemon.url);
    const currentPokemonName = chineseNames[currentPokemon.name] || capitalizeFirstLetter(currentPokemon.name);
    
    html += `
        <div class="evolution-pokemon" onclick="fetchAndShowPokemonById(${currentPokemonId})">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentPokemonId}.png" alt="${currentPokemon.name}">
            <p>${currentPokemonName}</p>
        </div>
    `;
    
    // å¦‚æœæœ‰è¿›åŒ–å½¢æ€
    if (chain.evolves_to && chain.evolves_to.length > 0) {
        html += '<div class="evolution-arrow">â†’</div><div class="evolution-branches">';
        
        // å¤„ç†æ¯ä¸ªè¿›åŒ–åˆ†æ”¯
        chain.evolves_to.forEach(evolution => {
            const evoPokemonId = extractPokemonId(evolution.species.url);
            const evoPokemonName = chineseNames[evolution.species.name] || capitalizeFirstLetter(evolution.species.name);
            
            html += `
                <div class="evolution-branch">
                    <div class="evolution-pokemon" onclick="fetchAndShowPokemonById(${evoPokemonId})">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${evoPokemonId}.png" alt="${evolution.species.name}">
                        <p>${evoPokemonName}</p>
                    </div>
            `;
            
            // å¦‚æœè¿˜æœ‰è¿›ä¸€æ­¥è¿›åŒ–
            if (evolution.evolves_to && evolution.evolves_to.length > 0) {
                html += '<div class="evolution-arrow">â†’</div><div class="evolution-branches">';
                
                evolution.evolves_to.forEach(finalEvolution => {
                    const finalEvoPokemonId = extractPokemonId(finalEvolution.species.url);
                    const finalEvoPokemonName = chineseNames[finalEvolution.species.name] || capitalizeFirstLetter(finalEvolution.species.name);
                    
                    html += `
                        <div class="evolution-pokemon" onclick="fetchAndShowPokemonById(${finalEvoPokemonId})">
                            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${finalEvoPokemonId}.png" alt="${finalEvolution.species.name}">
                            <p>${finalEvoPokemonName}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

// ä»URLä¸­æå–å®å¯æ¢¦ID
function extractPokemonId(url) {
    const matches = url.match(/\/(\d+)\/$/);
    return matches ? matches[1] : null;
}

// é€šè¿‡IDè·å–å¹¶æ˜¾ç¤ºå®å¯æ¢¦è¯¦æƒ…
async function fetchAndShowPokemonById(id) {
    try {
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}/`);
        const pokemon = await response.json();
        showPokemonDetails(pokemon);
    } catch (error) {
        console.error(`è·å–å®å¯æ¢¦ ID:${id} æ•°æ®å¤±è´¥:`, error);
    }
}

// æ”¶è—åŠŸèƒ½
function toggleFavorite(pokemonId) {
    let favorites = JSON.parse(localStorage.getItem('pokemonFavorites')) || [];
    
    if (isFavorite(pokemonId)) {
        // ç§»é™¤æ”¶è—
        favorites = favorites.filter(id => id !== pokemonId);
        localStorage.setItem('pokemonFavorites', JSON.stringify(favorites));
    } else {
        // æ·»åŠ æ”¶è—
        favorites.push(pokemonId);
        localStorage.setItem('pokemonFavorites', JSON.stringify(favorites));
    }
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateFavoriteButton(pokemonId);
}

// æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
function isFavorite(pokemonId) {
    const favorites = JSON.parse(localStorage.getItem('pokemonFavorites')) || [];
    return favorites.includes(pokemonId);
}

// æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
function updateFavoriteButton(pokemonId) {
    const favoriteButton = document.getElementById('favorite-button');
    if (favoriteButton) {
        favoriteButton.innerHTML = isFavorite(pokemonId) ? 'â¤ï¸ å–æ¶ˆæ”¶è—' : 'ğŸ¤ æ·»åŠ æ”¶è—';
    }
}

// è·å–å®å¯æ¢¦æ‰€å±çš„ä¸–ä»£
function getGeneration(id) {
    for (const [genNumber, genData] of Object.entries(generations)) {
        if (id >= genData.start && id <= genData.end) {
            return {
                number: genNumber,
                name: genData.name
            };
        }
    }
    return { number: '?', name: 'æœªçŸ¥' };
}

// è¾…åŠ©å‡½æ•°
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function getChineseType(type) {
    const typeMap = {
        'normal': 'ä¸€èˆ¬',
        'fire': 'ç«',
        'water': 'æ°´',
        'grass': 'è‰',
        'electric': 'ç”µ',
        'ice': 'å†°',
        'fighting': 'æ ¼æ–—',
        'poison': 'æ¯’',
        'ground': 'åœ°é¢',
        'flying': 'é£è¡Œ',
        'psychic': 'è¶…èƒ½åŠ›',
        'bug': 'è™«',
        'rock': 'å²©çŸ³',
        'ghost': 'å¹½çµ',
        'dragon': 'é¾™',
        'dark': 'æ¶',
        'steel': 'é’¢',
        'fairy': 'å¦–ç²¾'
    };
    return typeMap[type] || type;
}

function getChineseStat(stat) {
    const statMap = {
        'hp': 'ç”Ÿå‘½',
        'attack': 'æ”»å‡»',
        'defense': 'é˜²å¾¡',
        'special-attack': 'ç‰¹æ”»',
        'special-defense': 'ç‰¹é˜²',
        'speed': 'é€Ÿåº¦'
    };
    return statMap[stat] || stat;
}

// å…¨å±€å˜é‡
let selectedType = null;
let isFavoritesMode = false;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ– UI');
    
    // åˆå§‹åŒ–DOMå…ƒç´ 
    pokemonContainer = document.getElementById('pokemon-container');
    searchInput = document.getElementById('search-input');
    searchButton = document.getElementById('search-button');
    prevButton = document.getElementById('prev-button');
    nextButton = document.getElementById('next-button');
    firstPageButton = document.getElementById('first-page-button');
    lastPageButton = document.getElementById('last-page-button');
    currentPageSpan = document.getElementById('current-page');
    totalPagesSpan = document.getElementById('total-pages');
    pageInput = document.getElementById('page-input');
    jumpButton = document.getElementById('jump-button');
    modal = document.getElementById('pokemon-modal');
    modalClose = document.querySelector('.close');
    pokemonDetails = document.getElementById('pokemon-details');
    
    const themeToggle = document.getElementById('theme-toggle');
    const favoritesButton = document.getElementById('favorites-button');
    
    // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = 'â˜€ï¸ æ—¥é—´æ¨¡å¼';
    }
    
    // äº‹ä»¶ç›‘å¬
    searchButton.addEventListener('click', searchPokemons);
    searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            searchPokemons();
        }
    });
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            displayPokemons();
        }
    });
    nextButton.addEventListener('click', () => {
        const maxPage = Math.ceil(filteredPokemons.length / pokemonsPerPage);
        if (currentPage < maxPage) {
            currentPage++;
            displayPokemons();
        }
    });
    firstPageButton.addEventListener('click', () => {
        if (currentPage !== 1) {
            currentPage = 1;
            displayPokemons();
        }
    });
    lastPageButton.addEventListener('click', () => {
        const maxPage = Math.ceil(filteredPokemons.length / pokemonsPerPage);
        if (currentPage !== maxPage) {
            currentPage = maxPage;
            displayPokemons();
        }
    });
    
    // é¡µç è·³è½¬åŠŸèƒ½
    jumpButton.addEventListener('click', () => {
        jumpToPage();
    });
    
    pageInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            jumpToPage();
        }
    });
    modalClose.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // å¤œé—´æ¨¡å¼åˆ‡æ¢
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDarkMode);
        themeToggle.textContent = isDarkMode ? 'â˜€ï¸ æ—¥é—´æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
    });
    
    // æ·»åŠ é”®ç›˜å¯¼èˆª
    document.addEventListener('keydown', (e) => {
        // å¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼Œä¸å¤„ç†é”®ç›˜å¯¼èˆª
        if (modal.style.display === 'block') return;
        
        // å·¦ç®­å¤´ - ä¸Šä¸€é¡µ
        if (e.key === 'ArrowLeft' && !prevButton.disabled) {
            currentPage--;
            displayPokemons();
        }
        // å³ç®­å¤´ - ä¸‹ä¸€é¡µ
        else if (e.key === 'ArrowRight' && !nextButton.disabled) {
            currentPage++;
            displayPokemons();
        }
        // Homeé”® - é¦–é¡µ
        else if (e.key === 'Home' && !firstPageButton.disabled) {
            currentPage = 1;
            displayPokemons();
        }
        // Endé”® - æœ«é¡µ
        else if (e.key === 'End' && !lastPageButton.disabled) {
            const maxPage = Math.ceil(filteredPokemons.length / pokemonsPerPage);
            currentPage = maxPage;
            displayPokemons();
        }
    });
    
    // æ”¶è—æŒ‰é’®
    favoritesButton.addEventListener('click', () => {
        isFavoritesMode = !isFavoritesMode;
        favoritesButton.textContent = isFavoritesMode ? 'ğŸ” æ˜¾ç¤ºå…¨éƒ¨' : 'â¤ï¸ æˆ‘çš„æ”¶è—';
        
        if (isFavoritesMode) {
            showFavorites();
        } else {
            filterByGeneration(currentGeneration);
        }
    });
    
    // ä¸–ä»£é€‰æ‹©æŒ‰é’®äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.gen-button').forEach(button => {
        button.addEventListener('click', function() {
            if (isFavoritesMode) {
                isFavoritesMode = false;
                favoritesButton.textContent = 'â¤ï¸ æˆ‘çš„æ”¶è—';
            }
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.gen-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeç±»
            this.classList.add('active');
            
            // è®¾ç½®å½“å‰é€‰æ‹©çš„ä¸–ä»£
            currentGeneration = this.getAttribute('data-gen');
            console.log('é€‰æ‹©ä¸–ä»£:', currentGeneration);
            
            // é‡æ–°è¿‡æ»¤å®å¯æ¢¦å¹¶æ˜¾ç¤º
            filterByGeneration(currentGeneration);
        });
    });
    
    // å±æ€§ç­›é€‰æŒ‰é’®äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.type-button').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            
            if (isFavoritesMode) {
                isFavoritesMode = false;
                favoritesButton.textContent = 'â¤ï¸ æˆ‘çš„æ”¶è—';
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰é€‰ä¸­çš„å±æ€§ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
            if (selectedType === type) {
                selectedType = null;
                document.querySelectorAll('.type-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                filterByGeneration(currentGeneration);
            } else {
                selectedType = type;
                document.querySelectorAll('.type-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                filterByType(type);
            }
        });
    });
    
    // å¼€å§‹è·å–å®å¯æ¢¦æ•°æ®
    fetchPokemons();
});

// æŒ‰å±æ€§ç­›é€‰å®å¯æ¢¦
function filterByType(type) {
    if (currentGeneration === 'all') {
        filteredPokemons = allPokemons.filter(pokemon => 
            pokemon.types.some(t => t.type.name === type)
        );
    } else {
        const gen = generations[currentGeneration];
        filteredPokemons = allPokemons.filter(pokemon => 
            pokemon.id >= gen.start && 
            pokemon.id <= gen.end &&
            pokemon.types.some(t => t.type.name === type)
        );
    }
    
    currentPage = 1;
    displayPokemons();
}

// æ˜¾ç¤ºæ”¶è—çš„å®å¯æ¢¦
function showFavorites() {
    const favorites = JSON.parse(localStorage.getItem('pokemonFavorites')) || [];
    
    if (favorites.length === 0) {
        filteredPokemons = [];
        pokemonContainer.innerHTML = '<p class="no-results">æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å®å¯æ¢¦</p>';
        return;
    }
    
    filteredPokemons = allPokemons.filter(pokemon => favorites.includes(pokemon.id));
    currentPage = 1;
    displayPokemons();
}

// è·³è½¬åˆ°æŒ‡å®šé¡µç 
function jumpToPage() {
    const inputPage = parseInt(pageInput.value);
    const maxPage = Math.ceil(filteredPokemons.length / pokemonsPerPage);
    
    if (isNaN(inputPage) || inputPage < 1 || inputPage > maxPage) {
        // è¾“å…¥æ— æ•ˆï¼Œæ˜¾ç¤ºæç¤ºå¹¶ä¿ç•™è¾“å…¥å€¼
        pageInput.classList.add('invalid');
        setTimeout(() => {
            pageInput.classList.remove('invalid');
        }, 800);
        return;
    }
    
    currentPage = inputPage;
    displayPokemons();
    // ä¿ç•™è¾“å…¥å€¼ï¼Œæ–¹ä¾¿ç”¨æˆ·ç»§ç»­æ“ä½œ
}

//"æ›´æ–°ä¸»é¡µï¼Œæ·»åŠ è‡ªå®šä¹‰é¡µç è·³è½¬åŠŸèƒ½"
